<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-BRY21G04WJ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-BRY21G04WJ');
    </script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simple Platformer</title>
<style>
    body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
    }
    canvas {
        display: block;
        border: 2px solid black;
    }
    #dialogBox {
        position: absolute;
        top: 20px;
        font-family: sans-serif;
        padding: 10px;
        background-color: white;
        border: 1px solid black;
        margin: auto;
        width: 50%;
        height: 10%;
        display: block;
    }
</style>
</head>
<body>
<canvas id="gameCanvas" width="800" height="600"></canvas>
<div id="dialogBox"></div>
<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    const TILE_SIZE = 50;
    const LEVEL_WIDTH = 20;
    const LEVEL_HEIGHT = 15;

    let isDirty = true;

    const player = {
        x: 50,
        y: 50,
        width: 50,
        height: 50,
        speedX: 0,
        speedY: 0,
        jumpStrength: 10,
        grounded: false,
        image: new Image(),
        loadPlayerImage: function() {
            this.image.src = 'images/alfreds/leo.png';
        },

        jump: function() {
            if (this.grounded) {
                this.speedY = -this.jumpStrength;
                this.grounded = false;
                isDirty = true;
            }
        },
        update: function() {
            const prevX = this.x;
            const prevY = this.y;
            this.x += this.speedX;
            this.y += this.speedY;

            if (prevX !== this.x || prevY !== this.y) {
                isDirty = true;
            }

            if (this.x < 0) {
                this.x = 0;
            } else if (this.x + this.width > canvas.width) {
                this.x = canvas.width - this.width;
            }

            if (this.y < 0) {
                this.y = 0;
            } else if (this.y + this.height > canvas.height) {
                this.y = canvas.height - this.height;
            }

            if (this.y + this.height >= canvas.height) {
                this.y = canvas.height - this.height;
                this.grounded = true;
                this.speedY = 0;
            }

            for (let y = 0; y < levelMap.length; y++) {
                for (let x = 0; x < levelMap[y].length; x++) {
                    if (levelMap[y][x] === 2) {
                        if (this.x < (x + 1) * TILE_SIZE &&
                            this.x + this.width > x * TILE_SIZE &&
                            this.y < (y + 1) * TILE_SIZE &&
                            this.y + this.height > y * TILE_SIZE) {
                            this.x = prevX;
                            this.y = prevY;
                        }
                    }
                }
            }
        },
        draw: function() {
            ctx.drawImage(this.image, this.x, this.y, this.width, this.height);
        },
    };

    player.partyMembers = [];
    player.loadPlayerImage();

    const npcs = [
        { id: 1, x: 5, y: 6, image: 'images/alfreds/sky.png', dialogue: "On the surface I look calm and ready to drop bombs, but I keep on forgetting what I... uhhh. I forgot what I was gonna say... anyway let's go!                                          (Skye joined your party)" },
        { id: 2, x: 10, y: 5, image: 'images/alfreds/pink.png', dialogue: "pink best color lol                                          (Gwen joined your party)" },
        { id: 3, x: 5, y: 10, image: 'images/box.png', dialogue: "flannel" }
    ];

    function preloadNPCImages() {
        npcs.forEach(npc => {
            npc.imageObj = new Image();
            npc.imageObj.src = npc.image;
            npc.imageObj.onload = () => {
                updateGameArea();
            };
        });
    }

    preloadNPCImages();

    const levelMap = [
        [2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2],
        [2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2],
        [2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2],
        [2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2],
        [2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2],
        [2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2],
        [2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2],
        [2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2],
        [2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2],
        [2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2],
        [2, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2],
        [2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2],
    ];

    function drawPlatforms() {
        for (let y = 0; y < levelMap.length; y++) {
            for (let x = 0; x < levelMap[y].length; x++) {
                if (levelMap[y][x] === 1) {
                    ctx.fillStyle = 'green';
                    ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                } else if (levelMap[y][x] === 2) {
                    ctx.fillStyle = 'black';
                    ctx.fillRect(x * TILE_SIZE, y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                }
            }
        }
    }

    function drawNPCsLayer() {
        npcs.forEach(npc => {
            ctx.drawImage(npc.imageObj, npc.x * TILE_SIZE, npc.y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
        });
    }

    function updateGameArea() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        drawPlatforms();
        drawNPCsLayer();
        
        player.update();
        player.draw();

        player.partyMembers.forEach((partyMember, index) => {
            const distanceBehind = 60;
            const offsetX = -((index + 1) * distanceBehind);

            partyMember.x = player.x + offsetX;
            partyMember.y = player.y;

            ctx.drawImage(
                partyMember.imageObj,
                partyMember.x,
                partyMember.y,
                partyMember.width,
                partyMember.height
            );
        });
        
        requestAnimationFrame(updateGameArea);
    }

    window.addEventListener('keydown', function(event) {
        switch(event.key) {
            case 'a':
                player.speedX = -1;
                break;
            case 'd':
                player.speedX = 1;
                break;
            case 'w':
                player.speedY = -1;
                break;
            case 's':
                player.speedY = 1;
                break;
            case 'e':
                checkNPCInteraction();
                break;
        }
        isDirty = true;
    });

    window.addEventListener('keyup', function(event) {
        switch(event.key) {
            case 'a':
            case 'd':
                player.speedX = 0;
                break;
            case 'w':
            case 's':
                player.speedY = 0;
                break;
        }
        isDirty = true;
    });

    function checkNPCInteraction() {
    npcs.forEach((npc, index) => {
        if (
            Math.abs(player.x - npc.x * TILE_SIZE) <= TILE_SIZE &&
            Math.abs(player.y - npc.y * TILE_SIZE) <= TILE_SIZE
        ) {
            showNPCDialogue(npc, index);
        }
    });
}
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

function showNPCDialogue(npc, index) {
    const dialogBox = document.getElementById('dialogBox');
    dialogBox.style.display = 'block';
    dialogBox.innerHTML = '';

    let currentIndex = 0;
    const intervalId = setInterval(() => {
        dialogBox.innerHTML += npc.dialogue[currentIndex];
        currentIndex++;
        if (currentIndex === npc.dialogue.length) {
            clearInterval(intervalId);

            if (npc.id === 1) {
                player.partyMembers.push(npc);
                npcs.splice(index, 1);
            }
            if (npc.id === 2) {
                player.partyMembers.push(npc);
                npcs.splice(index, 1);
            }
        }
    }, 25);
}
    updateGameArea();
</script>
</body>
</html>
